# PinkButterfly CoreBrain

**Motor anal√≠tico profesional multi-timeframe para NinjaTrader 8**

Sistema de detecci√≥n, almacenamiento, puntuaci√≥n y mantenimiento de estructuras de precio (FVG, Swings, Order Blocks, BOS/CHoCH, POI, Liquidity Grabs) con API p√∫blica para consumo desde indicadores y estrategias.

---

## üéØ Objetivo

Desarrollar el **mejor analizador de mercado del mundo** con arquitectura modular, thread-safe, testeable y migrable a servicio externo. Sistema invisible que expone API para bots, estrategias e indicadores avanzados.

---

## üìä Estado del Proyecto

### ‚úÖ FASE 1: MVP - COMPLETADA (100%)

**Commit:** `dca2caf` - Fase 1 completada: CoreBrain MVP con IntervalTree, serializaci√≥n JSON y tests validados (11/11 PASS)

**Componentes Implementados:**

- ‚úÖ **CoreEngine.cs** - Motor principal con thread-safety (`ReaderWriterLockSlim`)
- ‚úÖ **EngineConfig.cs** - Configuraci√≥n serializable con Newtonsoft.Json
- ‚úÖ **StructureModels.cs** - Modelos de datos con herencia polim√≥rfica
- ‚úÖ **IBarDataProvider.cs** - Interfaz de abstracci√≥n para datos de barras
- ‚úÖ **ILogger.cs** - Sistema de logging con m√∫ltiples niveles
- ‚úÖ **IntervalTree.cs** - Indexado espacial O(log n + k) para consultas de rango
- ‚úÖ **IDetector.cs** - Interfaz para detectores de estructuras
- ‚úÖ **CoreBrainIndicator.cs** - Wrapper NinjaScript funcional
- ‚úÖ **MockBarDataProvider.cs** - Provider de pruebas
- ‚úÖ **TestRunnerIndicator.cs** - Indicador para ejecutar tests
- ‚úÖ **IntervalTreeTests.cs** - Suite de tests unitarios

**Tests Validados:**
- ‚úÖ 11/11 tests pasados
- ‚úÖ Performance: Insert 1000 items = 8ms, Query = 0ms
- ‚úÖ Complejidad O(log n + k) confirmada

**Dependencias:**
- Newtonsoft.Json 13.0.3 (incluida en `lib/`)

---

### ‚úÖ FASE 2: FVGDetector + Scoring - COMPLETADA (100%)

**Commit:** `2957531` - Fase 2: FVGDetector y ScoringEngine completos con 52 tests (100% pass)

**Componentes Implementados:**

- ‚úÖ **FVGDetector.cs** - Detector completo de Fair Value Gaps
  - Detecci√≥n de gaps bullish/bearish con validaci√≥n por tama√±o
  - Merge de FVGs consecutivos (configurable)
  - Detecci√≥n de FVGs anidados multi-nivel
  - Tracking de toques (body/wick)
  - C√°lculo de Fill Percentage con residual score
  
- ‚úÖ **ScoringEngine.cs** - Sistema de scoring multi-dimensional
  - TF Weight normalization
  - Freshness (decay exponencial)
  - Proximity din√°mica (ATR-based)
  - Touch factor (bonus por toques)
  - Fill handling (residual score)
  - Multi-timeframe scoring

- ‚úÖ **FVGDetectorTests.cs** - 12 tests b√°sicos
- ‚úÖ **FVGDetectorAdvancedTests.cs** - 29 tests avanzados

**Tests Validados:**
- ‚úÖ 52/52 tests pasados (100%)
  - 11/11 IntervalTree tests
  - 12/12 FVGDetector b√°sicos
  - 29/29 FVGDetector avanzados (merge, nested, fill, scoring, edge cases)
- ‚úÖ Cobertura: 95%
- ‚úÖ Confianza: 95%

**Bugs Corregidos:**
- ‚úÖ ATR calculation con barras insuficientes
- ‚úÖ L√≥gica de nested multi-nivel (buscar padre m√°s espec√≠fico)

**API P√∫blica:**
- `GetActiveFVGs(int tfMinutes, double minScore)` - Obtener FVGs activos filtrados por score

**Documentaci√≥n:**
- `docs/COBERTURA_TESTS.md` - Desglose completo de cobertura de tests
- `docs/INSTRUCCIONES_TESTS_AVANZADOS.md` - Gu√≠a de tests avanzados

---

### ‚úÖ FASE 3: SwingDetector - COMPLETADA (100%)

**Commit:** (pendiente) - Fase 3: SwingDetector completo con 78 tests (100% pass)

**Componentes Implementados:**

- ‚úÖ **SwingDetector.cs** - Detector completo de Swing Highs/Lows
  - Detecci√≥n con validaci√≥n estricta `nLeft`/`nRight` (ambos lados con `>=`)
  - Validaci√≥n de tama√±o m√≠nimo (ATR factor)
  - Detecci√≥n autom√°tica de ruptura (`IsBroken`)
  - Actualizaci√≥n de swings existentes en cada barra
  - Cache por timeframe para performance
  
- ‚úÖ **ScoringEngine.cs** - Actualizado con penalizaci√≥n de swings rotos
  - **Broken Swing Handling**: Penalizaci√≥n dr√°stica del 90% para swings rotos
  - Mantiene valor hist√≥rico (√∫til para BOS/CHoCH)
  - Scoring profesional alineado con SMC real

- ‚úÖ **SwingDetectorTests.cs** - 26 tests exhaustivos
  - Detecci√≥n b√°sica (High/Low)
  - Validaci√≥n `nLeft`/`nRight` (edge cases)
  - Validaci√≥n de tama√±o m√≠nimo
  - Detecci√≥n de ruptura (`IsBroken`)
  - Scoring y freshness
  - Edge cases (barras insuficientes, mercado plano, swings peque√±os)

**Tests Validados:**
- ‚úÖ 78/78 tests pasados (100%)
  - 11/11 IntervalTree tests
  - 12/12 FVGDetector b√°sicos
  - 29/29 FVGDetector avanzados
  - 26/26 SwingDetector tests
- ‚úÖ Cobertura: 98%
- ‚úÖ Confianza: 98%

**Bugs Corregidos:**
- ‚úÖ Validaci√≥n asim√©trica de swings (ahora usa `>=` en ambos lados)
- ‚úÖ Test de freshness decay (ahora compara 2 swings de diferentes edades)
- ‚úÖ Penalizaci√≥n profesional de swings rotos (10% del score original)

**API P√∫blica:**
- `GetRecentSwings(int tfMinutes, int maxCount)` - Obtener swings recientes ordenados por fecha

**Mejoras de Calidad:**
- ‚úÖ Swings rotos pierden el 90% de su score (comportamiento profesional SMC)
- ‚úÖ Validaci√≥n estricta: swing debe ser extremo √∫nico, no compartido
- ‚úÖ Tests exhaustivos con 26 escenarios diferentes

---

### ‚úÖ FASE 4: DoubleDetector - COMPLETADA (100%)

**Commit:** (pendiente) - Fase 4: DoubleDetector completo con 101 tests (100% pass)

**Componentes Implementados:**

- ‚úÖ **DoubleDetector.cs** - Detector completo de Double Tops/Bottoms
  - Detecci√≥n basada en swings del mismo tipo (High/High o Low/Low)
  - Validaci√≥n de proximidad de precio (`priceToleranceTicks`)
  - Validaci√≥n de distancia temporal (`minBarsBetween`, `maxBarsBetween`)
  - C√°lculo autom√°tico de neckline (low m√≠nimo para tops, high m√°ximo para bottoms)
  - Sistema de confirmaci√≥n (ruptura de neckline en direcci√≥n esperada)
  - Sistema de invalidaci√≥n (timeout si no confirma)
  - Estados: `Pending`, `Confirmed`, `Invalid`
  - Cache por timeframe para performance
  
- ‚úÖ **DoubleDetectorTests.cs** - 23 tests exhaustivos
  - Detecci√≥n b√°sica (Double Top/Bottom)
  - Validaci√≥n de tolerancia de precio (dentro/fuera)
  - Validaci√≥n temporal (min/max bars between)
  - C√°lculo de neckline
  - Confirmaci√≥n por ruptura de neckline
  - Invalidaci√≥n por timeout
  - Scoring profesional
  - Edge cases (m√∫ltiples doubles, insuficientes swings, ambos tipos)

**Tests Validados:**
- ‚úÖ 101/101 tests pasados (100%)
  - 11/11 IntervalTree tests
  - 12/12 FVGDetector b√°sicos
  - 29/29 FVGDetector avanzados
  - 26/26 SwingDetector tests
  - 23/23 DoubleDetector tests
- ‚úÖ Cobertura: 99%
- ‚úÖ Confianza: 99%

**API P√∫blica:**
- `GetDoubleTops(int tfMinutes, string status)` - Obtener Double Tops/Bottoms filtrados por status

**Mejoras de Calidad:**
- ‚úÖ Scoring profesional: el score refleja relevancia actual (freshness + proximity)
- ‚úÖ La confirmaci√≥n cambia el status, no infla artificialmente el score
- ‚úÖ Sistema de timeout para invalidar doubles que no confirman
- ‚úÖ Detecci√≥n autom√°tica de neckline basada en datos reales

---

### ‚úÖ FASE 5: OrderBlockDetector - COMPLETADA (100%) ‚≠ê

**Commit:** `290ceab` - Fase 5: OrderBlockDetector completo con 24/24 tests pasando (100%)

**Componentes Implementados:**

- ‚úÖ **OrderBlockDetector.cs** - Detector completo de Order Blocks
  - Detecci√≥n por tama√±o de cuerpo (`>= OBBodyMinATR * ATR`)
  - Detecci√≥n opcional por volumen spike (si disponible)
  - Rango OB = cuerpo de la vela (Open/Close)
  - Direction: "Bullish" (Close > Open) o "Bearish" (Close < Open)
  - Tracking de toques (body/wick)
  - **Sistema de mitigaci√≥n PROFESIONAL** (`IsMitigated` + `HasLeftZone`)
  - Detecci√≥n de Breaker Blocks (`IsBreaker`)
  - Cache por timeframe para performance
  
- ‚úÖ **OrderBlockDetectorTests.cs** - 24 tests exhaustivos
  - Detecci√≥n b√°sica (Bullish/Bearish OB)
  - Validaci√≥n de tama√±o m√≠nimo (ATR)
  - Detecci√≥n por volumen spike
  - Tracking de toques (body/wick)
  - **Mitigaci√≥n profesional** (precio sale y retorna)
  - Detecci√≥n de Breaker Blocks (OB roto y retesteado)
  - Scoring profesional
  - Edge cases (m√∫ltiples OBs, breakers, datos insuficientes)

- ‚úÖ **Mejoras al Sistema:**
  - `TestLogger` - Logging profesional para tests (Output Tab 2)
  - `GetAllStructures()` - API para obtener todas las estructuras sin filtros
  - `MockBarDataProvider` - Soporte para volumen nullable
  - `OrderBlockInfo.HasLeftZone` - Tracking profesional de mitigation

**Tests Validados:**
- ‚úÖ 101/101 tests pasados (100%)
  - 11/11 IntervalTree tests
  - 12/12 FVGDetector b√°sicos
  - 29/29 FVGDetector avanzados
  - 26/26 SwingDetector tests
  - 23/23 DoubleDetector tests
  - 24/24 OrderBlockDetector tests ‚≠ê NUEVO
- ‚úÖ Cobertura: 92%
- ‚úÖ Confianza: 94%

**API P√∫blica:**
- `GetOrderBlocks(int tfMinutes)` - Obtener Order Blocks ordenados por score
- `GetAllStructures(int tfMinutes)` - Obtener todas las estructuras sin filtros

**Conceptos Implementados:**

1. **Order Block (OB):**
   - Vela con cuerpo grande (institucional)
   - Zona donde se espera reacci√≥n del precio
   - Puede ser confirmado por volumen spike

2. **Mitigaci√≥n PROFESIONAL:**
   - El precio debe **salir completamente** de la zona (`HasLeftZone = true`)
   - Solo se mitiga cuando el precio **retorna** a la zona despu√©s de salir
   - Bullish OB: precio sube (sale), luego baja (retorna) ‚Üí mitigado
   - Bearish OB: precio baja (sale), luego sube (retorna) ‚Üí mitigado
   - **NO se auto-mitiga** en la barra de creaci√≥n

3. **Breaker Block:**
   - OB que fue completamente roto (close fuera del rango)
   - Luego retesteado desde el lado opuesto
   - Bullish OB ‚Üí Breaker: roto hacia abajo, retestea desde abajo
   - Bearish OB ‚Üí Breaker: roto hacia arriba, retestea desde arriba

**Par√°metros de Configuraci√≥n:**
- `OBBodyMinATR`: 0.6 (tama√±o m√≠nimo del cuerpo como factor del ATR)
- `VOL_SPIKE_FACTOR`: 1.5 (volumen > 1.5x promedio para confirmaci√≥n)
- `VOL_AVG_PERIOD`: 20 (per√≠odo para calcular volumen promedio)

**Bugs Corregidos:**
- ‚úÖ L√≥gica de mitigation profesional (requiere salida + retorno)
- ‚úÖ Auto-mitigation en barra de creaci√≥n (prevenido)
- ‚úÖ Spurious OBs en tests (setup bars mejorados)
- ‚úÖ TestLogger para logging visible en Output Tab 2

---

### ‚úÖ FASE 6: BOSDetector - COMPLETADA (100%) ‚≠ê

**Commit:** `020234c` - Fase 6: BOSDetector completo con 28 tests (100% pass) - Detecta BOS/CHoCH, calcula momentum, actualiza CurrentMarketBias con votaci√≥n ponderada

**Componentes Implementados:**

- ‚úÖ **BOSDetector.cs** - Detector completo de Break of Structure y Change of Character
  - Detecci√≥n de rupturas de swings (High/Low)
  - Clasificaci√≥n autom√°tica: **BOS** (contin√∫a tendencia) vs **CHoCH** (reversi√≥n)
  - Confirmaci√≥n de rupturas con `nConfirmBars_BOS`
  - C√°lculo de **Break Momentum** (Strong/Weak) basado en tama√±o de vela vs ATR
  - Tracking de swings procesados (cada swing solo se rompe una vez)
  - Cache por timeframe para performance
  
- ‚úÖ **CoreEngine.cs** - Actualizado con gesti√≥n de CurrentMarketBias
  - `GetStructureBreaks(int tfMinutes, string breakType, int maxCount)` - API para obtener breaks
  - `UpdateCurrentMarketBias(int tfMinutes)` - Algoritmo de votaci√≥n ponderada
  - **CurrentMarketBias**: "Bullish", "Bearish", "Neutral"
  - Weighted voting: Strong breaks = 2x peso, Weak breaks = 1x peso
  - Considera √∫ltimos N breaks (configurable con `MaxRecentBreaksForBias`)
  
- ‚úÖ **BOSDetectorTests.cs** - 28 tests exhaustivos
  - Detecci√≥n b√°sica (Bullish/Bearish breaks)
  - Clasificaci√≥n BOS vs CHoCH (4 tests)
  - Momentum Strong vs Weak (4 tests)
  - Actualizaci√≥n de CurrentMarketBias (5 tests)
  - Confirmaci√≥n con nConfirmBars (3 tests)
  - Scoring de breaks (3 tests)
  - Edge cases (6 tests)

**Tests Validados:**
- ‚úÖ 153/153 tests pasados (100%)
  - 11/11 IntervalTree tests
  - 12/12 FVGDetector b√°sicos
  - 29/29 FVGDetector avanzados
  - 26/26 SwingDetector tests
  - 23/23 DoubleDetector tests
  - 24/24 OrderBlockDetector tests
  - 28/28 BOSDetector tests ‚≠ê NUEVO
- ‚úÖ Cobertura: 93%
- ‚úÖ Confianza: 95%

**API P√∫blica:**
- `GetStructureBreaks(int tfMinutes)` - Obtener todos los breaks ordenados por score
- `GetStructureBreaks(int tfMinutes, string breakType, int maxCount)` - Filtrar por tipo (BOS/CHoCH)
- `CurrentMarketBias` - Propiedad que devuelve el bias actual: "Bullish", "Bearish", "Neutral"

**Conceptos Implementados:**

1. **Break of Structure (BOS):**
   - Ruptura que **contin√∫a la tendencia** actual
   - Ocurre cuando el precio rompe un swing en la direcci√≥n del CurrentMarketBias
   - Ejemplo: Bias Bullish + ruptura bullish de swing high = BOS
   - Indica continuaci√≥n de la tendencia dominante

2. **Change of Character (CHoCH):**
   - Ruptura que **indica reversi√≥n** de tendencia
   - Ocurre cuando el precio rompe un swing en direcci√≥n **contraria** al CurrentMarketBias
   - Ejemplo: Bias Bullish + ruptura bearish de swing low = CHoCH
   - Se√±al temprana de cambio de tendencia

3. **Break Momentum:**
   - **Strong**: Body size >= `BreakMomentumBodyFactor * ATR` (default: 0.6)
   - **Weak**: Body size < threshold
   - Los breaks Strong tienen 2x peso en el c√°lculo del CurrentMarketBias
   - Indica la fuerza institucional detr√°s de la ruptura

4. **CurrentMarketBias (Weighted Voting):**
   - Algoritmo que determina el bias del mercado basado en breaks recientes
   - Considera √∫ltimos `MaxRecentBreaksForBias` breaks (default: 10)
   - Strong breaks = peso 2.0, Weak breaks = peso 1.0
   - Bias = "Bullish" si >= 60% peso bullish
   - Bias = "Bearish" si >= 60% peso bearish
   - Bias = "Neutral" si ninguno alcanza 60%

5. **Confirmaci√≥n de Rupturas:**
   - `nConfirmBars_BOS`: N√∫mero de barras que deben confirmar la ruptura
   - Default: 1 (confirmaci√≥n inmediata)
   - Para mayor conservadurismo, usar 2-3 barras
   - Todas las barras de confirmaci√≥n deben cerrar m√°s all√° del swing

**Par√°metros de Configuraci√≥n:**
- `nConfirmBars_BOS`: 1 (barras de confirmaci√≥n para breaks)
- `MaxRecentBreaksForBias`: 10 (breaks recientes para calcular bias)
- `BreakMomentumBodyFactor`: 0.6 (factor ATR para momentum Strong)
- `BreakMomentumMultiplierStrong`: 2.0 (peso de breaks Strong en bias)
- `BreakMomentumMultiplierWeak`: 1.0 (peso de breaks Weak en bias)

**Bugs Corregidos:**
- ‚úÖ Swings ya rotos no se re-procesan (cache de swings procesados)
- ‚úÖ Confirmaci√≥n de rupturas con m√∫ltiples barras
- ‚úÖ C√°lculo correcto de momentum basado en ATR
- ‚úÖ Algoritmo de weighted voting para CurrentMarketBias

**Uso en Estrategias:**
```csharp
// Obtener breaks recientes
var allBreaks = core.GetStructureBreaks(60);
var bosBreaks = core.GetStructureBreaks(60, "BOS", maxCount: 10);
var chochBreaks = core.GetStructureBreaks(60, "CHoCH", maxCount: 10);

// Verificar bias actual
string bias = core.CurrentMarketBias;
if (bias == "Bullish")
{
    // Buscar entradas long en pullbacks
}
else if (bias == "Bearish")
{
    // Buscar entradas short en rallies
}

// Filtrar por momentum
var strongBreaks = allBreaks.Where(b => b.BreakMomentum == "Strong");
var weakBreaks = allBreaks.Where(b => b.BreakMomentum == "Weak");

// Detectar cambios de tendencia
var recentChoCH = chochBreaks.FirstOrDefault();
if (recentChoCH != null && recentChoCH.CreatedAtBarIndex >= currentBar - 5)
{
    // CHoCH reciente: posible reversi√≥n de tendencia
}
```

---

### üöß FASE 7: POIDetector (Pr√≥xima)

- POIDetector (Points of Interest)
- Liquidity Voids
- Confluence Zones

---

### üîÑ FASE 8: Persistencia y Optimizaci√≥n (Pendiente)

- Persistencia as√≠ncrona con debounce
- Sistema de eventos (`OnStructureAdded`, `OnStructureUpdated`, `OnStructureRemoved`)
- Purga autom√°tica por score
- Optimizaci√≥n de memoria

---

### üéÅ FASE 7: Migraci√≥n a DLL (Final)

- Compilaci√≥n a DLL para protecci√≥n de IP
- Sistema de licenciamiento
- Distribuci√≥n comercial

---

## üèóÔ∏è Arquitectura

### Separaci√≥n de Responsabilidades

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   NinjaTrader (CoreBrainIndicator)      ‚îÇ
‚îÇ   - Wrapper NinjaScript                 ‚îÇ
‚îÇ   - Implementa IBarDataProvider         ‚îÇ
‚îÇ   - Singleton Instance                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CoreEngine (POCO C#)                  ‚îÇ
‚îÇ   - L√≥gica del motor                    ‚îÇ
‚îÇ   - Thread-safe (ReaderWriterLockSlim)  ‚îÇ
‚îÇ   - Gesti√≥n de detectores               ‚îÇ
‚îÇ   - Scoring y persistencia              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Detectores (IDetector)                ‚îÇ
‚îÇ   - FVGDetector ‚úÖ                      ‚îÇ
‚îÇ   - SwingDetector ‚úÖ                    ‚îÇ
‚îÇ   - DoubleDetector ‚úÖ                   ‚îÇ
‚îÇ   - OrderBlockDetector ‚úÖ               ‚îÇ
‚îÇ   - BOSDetector ‚úÖ NUEVO                ‚îÇ
‚îÇ   - POIDetector (pr√≥ximo)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Indexado Espacial

- **IntervalTree**: O(log n + k) para consultas de rango
- Usado para confluence detection y POI
- Instancia por timeframe

---

## üöÄ Instalaci√≥n y Uso

### Requisitos

- NinjaTrader 8
- .NET Framework 4.8
- Newtonsoft.Json 13.0.3

### Instalaci√≥n

1. **Copiar Newtonsoft.Json.dll**:
   ```
   lib/Newtonsoft.Json.dll ‚Üí C:\Program Files\NinjaTrader 8\bin\Custom\
   ```

2. **Referenciar en NinjaTrader**:
   - Tools ‚Üí References ‚Üí Add ‚Üí Seleccionar `Newtonsoft.Json.dll`

3. **Copiar archivos fuente**:
   - Copiar todos los `.cs` de `src/` a tu carpeta local de NinjaTrader

4. **Compilar**:
   - Tools ‚Üí Compile (F5)

### Ejecutar Tests

1. Abrir cualquier gr√°fico en NinjaTrader
2. A√±adir indicador **"CoreBrainTestRunner"**
3. Ver resultados en **Output Tab 2**

### Usar CoreBrain

```csharp
// En otro indicador
var core = CoreBrain.Instance;

// FASE 2, 3 & 4: API disponible
var fvgs = core.GetActiveFVGs(60, minScore: 0.3);
foreach(var fvg in fvgs)
{
    Print($"FVG {fvg.Id} TF{fvg.TF} Score:{fvg.Score*100:F1}%");
}

var swings = core.GetRecentSwings(60, maxCount: 50);
foreach(var swing in swings)
{
    string type = swing.IsHigh ? "High" : "Low";
    string status = swing.IsBroken ? "BROKEN" : "Active";
    Print($"Swing {type} @ {swing.High:F2} [{status}] Score:{swing.Score*100:F1}%");
}

var doubles = core.GetDoubleTops(60, status: "Confirmed");
foreach(var dbl in doubles)
{
    string type = dbl.Type == "DOUBLE_TOP" ? "Double Top" : "Double Bottom";
    Print($"{type} @ {dbl.High:F2} Neckline:{dbl.NecklinePrice:F2} Score:{dbl.Score*100:F1}%");
}

var orderBlocks = core.GetOrderBlocks(60);
foreach(var ob in orderBlocks)
{
    string dir = ob.Direction;
    string status = ob.IsMitigated ? "MITIGATED" : (ob.IsBreaker ? "BREAKER" : "Active");
    Print($"OB {dir} [{ob.Low:F2}-{ob.High:F2}] [{status}] Touches:{ob.TouchCount_Body}/{ob.TouchCount_Wick} Score:{ob.Score*100:F1}%");
}

// FASE 6: BOS/CHoCH API
var breaks = core.GetStructureBreaks(60);
var bosBreaks = core.GetStructureBreaks(60, "BOS", maxCount: 10);
var chochBreaks = core.GetStructureBreaks(60, "CHoCH", maxCount: 10);

string bias = core.CurrentMarketBias; // "Bullish", "Bearish", "Neutral"
Print($"Current Market Bias: {bias}");

foreach(var brk in breaks)
{
    string momentum = brk.BreakMomentum; // "Strong" or "Weak"
    Print($"{brk.BreakType} {brk.Direction} @ {brk.BreakPrice:F2} [{momentum}] Score:{brk.Score*100:F1}%");
}
```

---

## üìÅ Estructura del Proyecto

```
PinkButterfly/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ Core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CoreEngine.cs ‚≠ê ACTUALIZADO (CurrentMarketBias)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EngineConfig.cs ‚≠ê ACTUALIZADO (par√°metros BOS)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ScoringEngine.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IBarDataProvider.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ StructureModels.cs ‚≠ê ACTUALIZADO (StructureBreakInfo)
‚îÇ   ‚îú‚îÄ‚îÄ Detectors/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IDetector.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FVGDetector.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SwingDetector.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DoubleDetector.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OrderBlockDetector.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ BOSDetector.cs ‚≠ê NUEVO
‚îÇ   ‚îú‚îÄ‚îÄ Infrastructure/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ILogger.cs (incluye TestLogger)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ IntervalTree.cs
‚îÇ   ‚îú‚îÄ‚îÄ NinjaTrader/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CoreBrainIndicator.cs
‚îÇ   ‚îî‚îÄ‚îÄ Testing/
‚îÇ       ‚îú‚îÄ‚îÄ MockBarDataProvider.cs
‚îÇ       ‚îú‚îÄ‚îÄ TestRunnerIndicator.cs ‚≠ê ACTUALIZADO
‚îÇ       ‚îú‚îÄ‚îÄ FVGDetectorTests.cs
‚îÇ       ‚îú‚îÄ‚îÄ FVGDetectorAdvancedTests.cs
‚îÇ       ‚îú‚îÄ‚îÄ SwingDetectorTests.cs
‚îÇ       ‚îú‚îÄ‚îÄ DoubleDetectorTests.cs
‚îÇ       ‚îú‚îÄ‚îÄ OrderBlockDetectorTests.cs
‚îÇ       ‚îî‚îÄ‚îÄ BOSDetectorTests.cs ‚≠ê NUEVO
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ IntervalTreeTests.cs
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ Newtonsoft.Json.dll
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ INSTRUCCIONES_NEWTONSOFT.md
‚îÇ   ‚îî‚îÄ‚îÄ promp-inicial-definicion-del-proyecto.txt
‚îú‚îÄ‚îÄ export/
‚îÇ   ‚îî‚îÄ‚îÄ (archivos temporales para testing)
‚îî‚îÄ‚îÄ README.md
```

---

## üß™ Testing

### Suite de Tests Actual

- **IntervalTreeTests**: 11 tests
  - Insert, QueryOverlap, Remove, QueryPoint
  - Performance validation

- **FVGDetectorTests (B√°sicos)**: 12 tests
  - Detecci√≥n bullish/bearish
  - Validaci√≥n de tama√±o m√≠nimo
  - Scoring inicial y decay
  - Touch factor

- **FVGDetectorAdvancedTests**: 29 tests
  - Merge de FVGs consecutivos
  - FVGs anidados multi-nivel
  - Fill percentage y residual score
  - M√∫ltiples FVGs y timeframes
  - Edge cases

- **SwingDetectorTests**: 26 tests
  - Detecci√≥n b√°sica High/Low
  - Validaci√≥n nLeft/nRight
  - Validaci√≥n de tama√±o m√≠nimo
  - Detecci√≥n de ruptura (IsBroken)
  - Scoring y freshness
  - Edge cases

- **DoubleDetectorTests**: 23 tests
  - Detecci√≥n b√°sica Double Top/Bottom
  - Validaci√≥n de tolerancia de precio
  - Validaci√≥n temporal (min/max bars)
  - C√°lculo de neckline
  - Confirmaci√≥n por ruptura
  - Invalidaci√≥n por timeout
  - Scoring profesional
  - Edge cases

- **OrderBlockDetectorTests**: 24 tests
  - Detecci√≥n b√°sica Bullish/Bearish OB
  - Validaci√≥n de tama√±o m√≠nimo (ATR)
  - Detecci√≥n por volumen spike
  - Tracking de toques (body/wick)
  - Mitigaci√≥n profesional (salida + retorno)
  - Breaker Blocks (roto + retesteado)
  - Scoring profesional
  - Edge cases (m√∫ltiples OBs, breakers)

- **BOSDetectorTests**: 28 tests ‚≠ê NUEVO
  - Detecci√≥n b√°sica de breaks (Bullish/Bearish)
  - Clasificaci√≥n BOS vs CHoCH (4 tests)
  - Momentum Strong vs Weak (4 tests)
  - Actualizaci√≥n de CurrentMarketBias (5 tests)
  - Confirmaci√≥n con nConfirmBars (3 tests)
  - Scoring de breaks (3 tests)
  - Edge cases (6 tests)

### Resultados

```
==============================================
RESUMEN TOTAL - FASE 1, 2, 3, 4, 5 & 6
==============================================

IntervalTree Tests:             11/11 ‚úÖ (100%)
FVG Detector Tests (B√°sicos):   12/12 ‚úÖ (100%)
FVG Detector Tests (Avanzados): 29/29 ‚úÖ (100%)
Swing Detector Tests:           26/26 ‚úÖ (100%)
Double Detector Tests:          23/23 ‚úÖ (100%)
Order Block Detector Tests:     24/24 ‚úÖ (100%)
BOS Detector Tests:             28/28 ‚úÖ (100%) ‚≠ê NUEVO

==============================================
TOTAL: 153/153 tests passed (100%)
==============================================
```

---

## üîß Configuraci√≥n

### Par√°metros por Defecto (EngineConfig)

```csharp
TimeframesToUse: [15, 60, 240, 1440]  // minutos
MinFVGSizeTicks: 6
MinFVGSizeATRfactor: 0.12
MinSwingATRfactor: 0.05
ProxMaxATRFactor: 2.5
FreshnessLambda: 20
DecayLambda: 100
TouchBodyBonusPerTouch: 0.12
MaxTouchBodyCap: 5
ConfluenceWeight: 0.18
FillThreshold: 0.90
ResidualScore: 0.05
MaxStructuresPerTF: 500
MergeConsecutiveFVGs: true
DetectNestedFVGs: true
EnableDebug: false
```

---

## üìù Principios de Desarrollo

1. **Separaci√≥n estricta**: Engine POCO sin dependencias de NinjaTrader
2. **Thread-safety**: `ReaderWriterLockSlim` para acceso concurrente
3. **Testeable**: Inyecci√≥n de dependencias y mocks
4. **Performance**: Indexado espacial O(log n + k)
5. **Profesional**: Sin hacks ni soluciones intermedias
6. **Migrable**: F√°cil conversi√≥n a servicio externo o DLL

---

## üìö Documentaci√≥n

- **Definici√≥n del Proyecto**: `docs/promp-inicial-definicion-del-proyecto.txt`
- **Instrucciones Newtonsoft**: `docs/INSTRUCCIONES_NEWTONSOFT.md`
- **Comentarios en c√≥digo**: Espa√±ol, exhaustivos

---

## ü§ù Contribuci√≥n

Este es un proyecto privado en desarrollo. Fase actual: **Fase 1 completada, iniciando Fase 2**.

---

## üìÑ Licencia

Propietario: Proyecto privado. Sistema comercial en desarrollo.

---

## üéØ Roadmap

- [x] **Fase 0**: Setup inicial y estructura
- [x] **Fase 1**: MVP con IntervalTree y tests (11/11 PASS)
- [x] **Fase 2**: FVGDetector + Scoring (41/41 PASS)
- [x] **Fase 3**: SwingDetector (26/26 PASS)
- [x] **Fase 4**: DoubleDetector (23/23 PASS)
- [x] **Fase 5**: OrderBlockDetector (24/24 PASS)
- [x] **Fase 6**: BOSDetector (28/28 PASS) ‚≠ê COMPLETADA
- [ ] **Fase 7**: POIDetector y Liquidity Voids
- [ ] **Fase 8**: Persistencia y optimizaci√≥n
- [ ] **Fase 9**: Migraci√≥n a DLL y licenciamiento

---

**√öltima actualizaci√≥n**: Fase 6 completada - Tests 153/153 PASS (100%) - BOSDetector con clasificaci√≥n BOS/CHoCH, momentum Strong/Weak, y CurrentMarketBias con weighted voting
